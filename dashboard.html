<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CloudClips</title>
  <link rel="stylesheet" href="styles.css"/>
  <script src="global.js"></script>
</head>
<body>
  <div class="dashboard-container">
    <!-- Home Button -->
    <button 
      onclick="window.location.href='index.html'" 
      style="background:#4CAF50; color:white; border:none; padding:10px 16px; border-radius:6px; cursor:pointer; margin-bottom:15px;">
      üè† Home
    </button>
  <div class="dashboard-container">
    <h1>All Users Dashboard</h1>

    <table class="dashboard-table">
      <thead>
        <tr>
          <th>Profile Name</th>
          <th>Email</th>
          <th>Sign-In History</th>
          <th>Posts</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="dashboardBody"></tbody>
    </table>
  </div>

  <!-- Edit Modal -->
  <div id="edit-profile-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" onclick="cancelEdit()">&times;</span>
      <h2>Edit Profile</h2>
      <form id="editProfileForm">
        <input type="hidden" id="editUserEmail" />
        <label>First Name</label>
        <input type="text" id="editFirstName" required />
        <label>Last Name</label>
        <input type="text" id="editLastName" required />
        <label>Phone</label>
        <input type="text" id="editPhone" required />
        <button type="submit">Save</button>
      </form>
    </div>
  </div>

  <script>
    const users = JSON.parse(localStorage.getItem('users')) || [];
    const signInHistory = JSON.parse(localStorage.getItem('signInHistory')) || {};
    const posts = JSON.parse(localStorage.getItem('posts')) || [];
    const loggedInUser = JSON.parse(localStorage.getItem('loggedInUser'));
    const dashboardBody = document.getElementById('dashboardBody');

    function renderDashboard() {
      dashboardBody.innerHTML = '';

      const allUsers = JSON.parse(localStorage.getItem('users')) || [];

      allUsers.forEach(user => {
        const tr = document.createElement('tr');

        const nameTd = document.createElement('td');
        nameTd.textContent = `${user.firstName} ${user.lastName}`;
        const emailTd = document.createElement('td');
        emailTd.textContent = user.email;

        const historyTd = document.createElement('td');
        const history = signInHistory[user.email] || [];
        historyTd.innerHTML = history.length
          ? '<ul>' + history.map(h => `<li>${new Date(h).toLocaleString()}</li>`).join('') + '</ul>'
          : '‚Äî';

        const postsTd = document.createElement('td');
        const userPosts = posts.filter(p => p.userEmail === user.email);
        postsTd.innerHTML = userPosts.length
          ? '<ul>' + userPosts.map(p => `<li>${p.title || 'Untitled'}</li>`).join('') + '</ul>'
          : '‚Äî';

        const actionsTd = document.createElement('td');
        if (loggedInUser && loggedInUser.email === user.email) {
          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.onclick = () => showEditForm(user);
          actionsTd.appendChild(editBtn);
        }

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Delete';
        deleteBtn.onclick = () => deleteUser(user.email);
        actionsTd.appendChild(deleteBtn);

        tr.append(nameTd, emailTd, historyTd, postsTd, actionsTd);
        dashboardBody.appendChild(tr);
      });
    }

    function showEditForm(user) {
      document.getElementById('editUserEmail').value = user.email;
      document.getElementById('editFirstName').value = user.firstName;
      document.getElementById('editLastName').value = user.lastName;
      document.getElementById('editPhone').value = user.phone || '';
      document.getElementById('edit-profile-modal').style.display = 'block';
    }

    function cancelEdit() {
      document.getElementById('edit-profile-modal').style.display = 'none';
    }

    document.getElementById('editProfileForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const email = document.getElementById('editUserEmail').value;
      const updatedFirstName = document.getElementById('editFirstName').value.trim();
      const updatedLastName = document.getElementById('editLastName').value.trim();
      const updatedPhone = document.getElementById('editPhone').value.trim();

      let allUsers = JSON.parse(localStorage.getItem('users')) || [];

      allUsers = allUsers.map(u => {
        if (u.email === email) {
          return { ...u, firstName: updatedFirstName, lastName: updatedLastName, phone: updatedPhone };
        }
        return u;
      });

      localStorage.setItem('users', JSON.stringify(allUsers));

      if (loggedInUser && loggedInUser.email === email) {
        const updatedUser = { ...loggedInUser, firstName: updatedFirstName, lastName: updatedLastName, phone: updatedPhone };
        localStorage.setItem('loggedInUser', JSON.stringify(updatedUser));
      }

      alert('Profile updated.');
      cancelEdit();
      renderDashboard();
    });

    function deleteUser(email) {
      if (!confirm('Are you sure you want to delete this user?')) return;

      let allUsers = JSON.parse(localStorage.getItem('users')) || [];
      allUsers = allUsers.filter(u => u.email !== email);
      localStorage.setItem('users', JSON.stringify(allUsers));

      const postList = JSON.parse(localStorage.getItem('posts')) || [];
      const updatedPosts = postList.filter(p => p.userEmail !== email);
      localStorage.setItem('posts', JSON.stringify(updatedPosts));

      const history = JSON.parse(localStorage.getItem('signInHistory')) || {};
      delete history[email];
      localStorage.setItem('signInHistory', JSON.stringify(history));

      if (loggedInUser && loggedInUser.email === email) {
        localStorage.removeItem('loggedInUser');
        alert('Your account was deleted. Redirecting to sign in.');
        window.location.href = 'signin.html';
        return;
      }

      renderDashboard();
    }

    renderDashboard();
  </script>
</body>
</html>
